<script>
  async function loadCharacterData() {
    try {
      const response = await fetch(`./data/${characterName}.json`);
      characterData = await response.json();
      updateUI();
    } catch (e) {
      console.error("❌ キャラクターデータの読み込みに失敗:", e);
    }
  }

  async function initCharacters() {
    try {
      const response = await fetch("./data/characters.json");
      characterList = await response.json();

      const selector = document.getElementById("characterSelector");
      selector.innerHTML = characterList.map(c => `<option value="${c.name}">${c.label}</option>`).join("");

      const urlParams = new URLSearchParams(window.location.search);
      const charParam = urlParams.get("character");
      if (charParam) characterName = charParam;
      else characterName = characterList[0]?.name || "alice";

      await loadCharacterData();
    } catch (e) {
      console.error("❌ キャラクター一覧の読み込みに失敗:", e);
    }
  }

  function updateUI() {
    const now = new Date();
    const hour = now.getHours();
    const timeSlot = getTimeSlot(hour);
    const dayName = getDayName();
    const special = checkSpecialDay();

    const img = document.getElementById("character");
    const caption = document.getElementById("caption");
    const background = document.getElementById("background");

    if (special) {
      background.style.backgroundImage = `url('./${special.background}')`;
      caption.textContent = special.message;
      img.src = `./img/${characterName}_happy.png`;
      document.getElementById("debugInfo").textContent = `🎉 特別日: ${special.label}`;
      return;
    }

    const expression = characterData.expressions?.[timeSlot] || "normal";
    let message = characterData.lines?.[timeSlot] || "";

    if (characterData.weatherLines?.[timeSlot]?.[weather]) {
      message = characterData.weatherLines[timeSlot][weather];
    }

    if (characterData.weekdayLines?.[dayName]) {
      message += "\n" + characterData.weekdayLines[dayName];
    }

    img.src = `./img/${characterName}_${expression}.png`;
    background.style.backgroundImage = `url('./img/background_${timeSlot}_${weather}.png')`;
    caption.textContent = message;

    document.getElementById("debugInfo").textContent = `天気: ${weather} ／ 時間帯: ${timeSlot} ／ 曜日: ${dayName}`;
  }
</script>
